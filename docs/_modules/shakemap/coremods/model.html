
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>shakemap.coremods.model &#8212; ShakeMap Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/northridge_points.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for shakemap.coremods.model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Process a ShakeMap, based on the configuration and data found in</span>
<span class="sd">shake_data.hdf, and produce output in shake_result.hdf.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">gmtime</span><span class="p">,</span> <span class="n">strftime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">numexpr</span> <span class="k">as</span> <span class="nn">ne</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="k">import</span> <span class="n">maskoceans</span>
<span class="kn">from</span> <span class="nn">openquake.hazardlib</span> <span class="k">import</span> <span class="n">imt</span>
<span class="kn">import</span> <span class="nn">openquake.hazardlib.const</span> <span class="k">as</span> <span class="nn">oqconst</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">CoreModule</span>
<span class="kn">from</span> <span class="nn">shakelib.rupture.point_rupture</span> <span class="k">import</span> <span class="n">PointRupture</span>
<span class="kn">from</span> <span class="nn">shakelib.sites</span> <span class="k">import</span> <span class="n">Sites</span>
<span class="kn">from</span> <span class="nn">shakelib.distance</span> <span class="k">import</span> <span class="p">(</span><span class="n">Distance</span><span class="p">,</span>
                               <span class="n">get_distance</span><span class="p">,</span>
                               <span class="n">get_distance_measures</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">shakelib.multigmpe</span> <span class="k">import</span> <span class="n">MultiGMPE</span>
<span class="kn">from</span> <span class="nn">shakelib.virtualipe</span> <span class="k">import</span> <span class="n">VirtualIPE</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.utils</span> <span class="k">import</span> <span class="n">get_extent</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.imt_string</span> <span class="k">import</span> <span class="n">oq_to_file</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.containers</span> <span class="k">import</span> <span class="n">ShakeMapInputContainer</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.containers</span> <span class="k">import</span> <span class="n">ShakeMapOutputContainer</span>
<span class="kn">from</span> <span class="nn">shakelib.utils.distance</span> <span class="k">import</span> <span class="n">geodetic_distance_fast</span>

<span class="kn">from</span> <span class="nn">mapio.geodict</span> <span class="k">import</span> <span class="n">GeoDict</span>
<span class="kn">from</span> <span class="nn">mapio.grid2d</span> <span class="k">import</span> <span class="n">Grid2D</span>

<span class="kn">from</span> <span class="nn">shakemap.utils.config</span> <span class="k">import</span> <span class="n">get_config_paths</span>
<span class="kn">from</span> <span class="nn">shakemap.utils.utils</span> <span class="k">import</span> <span class="n">get_object_from_config</span>
<span class="kn">from</span> <span class="nn">shakemap._version</span> <span class="k">import</span> <span class="n">get_versions</span>

<span class="c1">#</span>
<span class="c1"># TODO: Some constants; these should maybe be in a configuration</span>
<span class="c1"># or in a constants module or be GMICE-specific.</span>
<span class="c1">#</span>
<span class="c1"># default_mmi_stddev: the standard deviation of MMI values if it</span>
<span class="c1">#                     is not specified in the input</span>
<span class="c1"># min_mmi_convert: the minimum MMI to convert to PGM -- low </span>
<span class="c1">#                  intensities don&#39;t convert very accurately</span>
<span class="c1"># default_stddev_inter: This is a stand-in for tau when the gmpe set </span>
<span class="c1">#                       doesn&#39;t provide it. It is an educated guess </span>
<span class="c1">#                       based on the NGA-east work and BC Hydro gmpe.</span>
<span class="c1">#                       It&#39;s not perfect, but probably isn&#39;t too far off. </span>
<span class="c1">#                       It is only used when the GMPEs don&#39;t provide a </span>
<span class="c1">#                       breakdown of the uncertainty terms.</span>
<span class="c1">#</span>
<span class="n">SM_CONSTS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default_mmi_stddev&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
             <span class="s1">&#39;min_mmi_convert&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
             <span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">}</span>


<div class="viewcode-block" id="ModelModule"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule">[docs]</a><span class="k">class</span> <span class="nc">ModelModule</span><span class="p">(</span><span class="n">CoreModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    model -- Interpolate ground motions to a grid or list of locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">command_name</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span>

<div class="viewcode-block" id="ModelModule.execute"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.ModelModule.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate ground motions to a grid or list of locations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotADirectoryError: When the event data directory does not exist.</span>
<span class="sd">            FileNotFoundError: When the the shake_data HDF file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Find the shake_data file</span>
        <span class="c1">#</span>
        <span class="n">install_path</span><span class="p">,</span> <span class="n">data_path</span> <span class="o">=</span> <span class="n">get_config_paths</span><span class="p">()</span>
        <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid directory.&#39;</span> <span class="o">%</span> <span class="n">datadir</span><span class="p">)</span>

        <span class="n">datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;shake_data.hdf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">datafile</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Clear away results from previous runs</span>
        <span class="c1">#</span>
        <span class="n">products_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">products_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">products_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Make the input container and extract the config</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">ShakeMapInputContainer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">getConfig</span><span class="p">()</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Instantiate the gmpe, gmice, ipe, and ccf</span>
        <span class="c1"># Here we make a placeholder gmpe so that we can make the</span>
        <span class="c1"># rupture and distance contexts; later we&#39;ll make the</span>
        <span class="c1"># IMT-specific gmpes</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">default_gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">gmice</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s1">&#39;gmice&#39;</span><span class="p">,</span> <span class="s1">&#39;modeling&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ipe_modules&#39;</span><span class="p">][</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VirtualIPE&#39;</span><span class="p">:</span>
            <span class="n">pgv_imt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">)</span>
            <span class="n">ipe_gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">pgv_imt</span><span class="p">)</span>
            <span class="n">ipe</span> <span class="o">=</span> <span class="n">VirtualIPE</span><span class="o">.</span><span class="n">fromFuncs</span><span class="p">(</span><span class="n">ipe_gmpe</span><span class="p">,</span> <span class="n">gmice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ipe</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s1">&#39;ipe&#39;</span><span class="p">,</span> <span class="s1">&#39;modeling&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Bias parameters</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">do_bias</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;do_bias&#39;</span><span class="p">]</span>
        <span class="n">bias_max_range</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;max_range&#39;</span><span class="p">]</span>
        <span class="n">bias_max_mag</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;max_mag&#39;</span><span class="p">]</span>
        <span class="n">bias_max_dsigma</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;max_delta_sigma&#39;</span><span class="p">]</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Outlier parameters</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">outlier_deviation_level</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;outlier&#39;</span><span class="p">][</span><span class="s1">&#39;max_deviation&#39;</span><span class="p">]</span>
        <span class="n">outlier_max_mag</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;outlier&#39;</span><span class="p">][</span><span class="s1">&#39;max_mag&#39;</span><span class="p">]</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># These are the IMTs we want to make</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">imt_out_set_str</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;imt_list&#39;</span><span class="p">])</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Get the rupture object and rupture context</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">rupture_obj</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">getRuptureObject</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;mechanism&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">]:</span>
            <span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">setMechanism</span><span class="p">(</span>
                <span class="n">mech</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;mechanism&#39;</span><span class="p">])</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">rupture_obj</span><span class="o">.</span><span class="n">getRuptureContext</span><span class="p">([</span><span class="n">default_gmpe</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rx</span><span class="o">.</span><span class="n">rake</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rx</span><span class="o">.</span><span class="n">rake</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Get the Vs30 file name</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">vs30default</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;vs30default&#39;</span><span class="p">]</span>
        <span class="n">vs30_file</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;vs30file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vs30_file</span><span class="p">:</span>
            <span class="n">vs30_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># The output locations: either a grid or a list of points</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">smdx</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;xres&#39;</span><span class="p">]</span>
        <span class="n">smdy</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;yres&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: functionize these blocks?</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># FILE: Open the file and get the output points</span>
            <span class="c1">#</span>
            <span class="n">do_grid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">in_sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">],</span>
                <span class="n">autostrip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="s1">&#39;&lt;U80&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">in_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Points file is empty; nothing to do&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">in_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="n">idents</span> <span class="o">=</span> <span class="n">in_sites</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">idents</span> <span class="o">=</span> <span class="p">[</span><span class="n">idents</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="n">idents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">in_sites</span><span class="p">)</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">vs30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vs30</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">smnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
            <span class="n">smny</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">depths</span><span class="p">,</span>
                                    <span class="n">rupture_obj</span><span class="p">)</span>

            <span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">smdx</span><span class="p">,</span> <span class="n">smdy</span><span class="p">,</span>
                                             <span class="n">defaultVs30</span><span class="o">=</span><span class="n">vs30default</span><span class="p">,</span>
                                             <span class="n">vs30File</span><span class="o">=</span><span class="n">vs30_file</span><span class="p">)</span>

            <span class="n">sx_out_soil</span> <span class="o">=</span> <span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">({</span><span class="s1">&#39;lats&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="p">,</span>
                                                         <span class="s1">&#39;lons&#39;</span><span class="p">:</span> <span class="n">lons</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># GRID: Figure out the grid parameters and get output points</span>
            <span class="c1">#</span>
            <span class="n">do_grid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">smdx</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;xres&#39;</span><span class="p">]</span>
            <span class="n">smdy</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;yres&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;extent&#39;</span><span class="p">]:</span>
                <span class="n">W</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;prediction_location&#39;</span><span class="p">][</span><span class="s1">&#39;extent&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">W</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">get_extent</span><span class="p">(</span><span class="n">rupture_obj</span><span class="p">)</span>

            <span class="n">sites_obj_out</span> <span class="o">=</span> <span class="n">Sites</span><span class="o">.</span><span class="n">fromBounds</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">smdx</span><span class="p">,</span> <span class="n">smdy</span><span class="p">,</span>
                                             <span class="n">defaultVs30</span><span class="o">=</span><span class="n">vs30default</span><span class="p">,</span>
                                             <span class="n">vs30File</span><span class="o">=</span><span class="n">vs30_file</span><span class="p">)</span>
            <span class="n">smnx</span><span class="p">,</span> <span class="n">smny</span> <span class="o">=</span> <span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getNxNy</span><span class="p">()</span>
            <span class="n">sx_out_soil</span> <span class="o">=</span> <span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">()</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">sx_out_soil</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="n">sx_out_soil</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
            <span class="n">dist_obj_out</span> <span class="o">=</span> <span class="n">Distance</span><span class="o">.</span><span class="n">fromSites</span><span class="p">(</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="n">sites_obj_out</span><span class="p">,</span>
                                              <span class="n">rupture_obj</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># TODO: This will break if the IPE needs distance measures</span>
        <span class="c1"># that the GMPE doesn&#39;t; should make this a union of the</span>
        <span class="c1"># requirements of both</span>
        <span class="c1">#</span>
        <span class="n">dx_out</span> <span class="o">=</span> <span class="n">dist_obj_out</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>

        <span class="n">lons_out_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
        <span class="n">lats_out_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Station data</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">getStationList</span><span class="p">()</span>
        <span class="n">gmpe_sd_types</span> <span class="o">=</span> <span class="n">default_gmpe</span><span class="o">.</span><span class="n">DEFINED_FOR_STANDARD_DEVIATION_TYPES</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmpe_sd_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">total_sd_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_sd_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">stddev_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">TOTAL</span><span class="p">,</span> <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTER_EVENT</span><span class="p">,</span>
                            <span class="n">oqconst</span><span class="o">.</span><span class="n">StdDev</span><span class="o">.</span><span class="n">INTRA_EVENT</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># df1 holds the instrumented data (PGA, PGV, SA)</span>
        <span class="c1"># df2 holds the non-instrumented data (MMI)</span>
        <span class="c1">#</span>
        <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">imt_in_str_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">imt_in_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">imt_in_str_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">sx_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">dx_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stations</span><span class="o">.</span><span class="n">getStationDictionary</span><span class="p">(</span><span class="n">instrumented</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stations</span><span class="o">.</span><span class="n">getStationDictionary</span><span class="p">(</span><span class="n">instrumented</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Make the sites and distance contexts for each dictionary then</span>
            <span class="c1"># compute the predictions for the IMTs in that dictionary.</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">ndf</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="p">:</span>
                    <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">imt_in_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="c1">#</span>
                <span class="c1"># Make lists of the input IMTs</span>
                <span class="c1">#</span>
                <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PGA&#39;</span><span class="p">,</span> <span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="s1">&#39;MMI&#39;</span><span class="p">)</span> <span class="ow">or</span>
                     <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_sd&#39;</span><span class="p">))])</span>
                <span class="n">imt_in_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]])</span>
                <span class="n">imt_in_str_set</span> <span class="o">|=</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># Get the sites and distance contexts</span>
                <span class="c1">#</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
                <span class="n">lldict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lons&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="s1">&#39;lats&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]}</span>
                <span class="n">sx_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="n">sites_obj_out</span><span class="o">.</span><span class="n">getSitesContext</span><span class="p">(</span><span class="n">lldict</span><span class="p">)</span>
                <span class="n">dist_obj</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span><span class="n">default_gmpe</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span>
                                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">rupture_obj</span><span class="p">)</span>
                <span class="n">dx_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_obj</span><span class="o">.</span><span class="n">getDistanceContext</span><span class="p">()</span>
                <span class="c1">#</span>
                <span class="c1"># Do the predictions and other bookkeeping for each IMT</span>
                <span class="c1">#</span>
                <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]:</span>
                    <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
                    <span class="n">gmpe</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                        <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
                    <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="n">gmas</span><span class="p">(</span><span class="n">ipe</span><span class="p">,</span> <span class="n">gmpe</span><span class="p">,</span> <span class="n">sx_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">],</span> <span class="n">rx</span><span class="p">,</span>
                                          <span class="n">dx_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">stddev_types</span><span class="p">)</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">total_sd_only</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">]</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                            <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">],</span> <span class="n">tau_guess</span><span class="p">)</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
                                                           <span class="n">tau_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="c1"># Compute the total residual</span>
                    <span class="c1">#</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span>
                    <span class="c1"># ----------------------------------------------------------</span>
                    <span class="c1"># Do the outlier flagging if we don&#39;t have a fault and</span>
                    <span class="c1"># the event magnitude is over the limit</span>
                    <span class="c1"># ----------------------------------------------------------</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span> <span class="ow">or</span> \
                       <span class="n">rx</span><span class="o">.</span><span class="n">mag</span> <span class="o">&lt;=</span> <span class="n">outlier_max_mag</span><span class="p">:</span>
                        <span class="c1">#</span>
                        <span class="c1"># turn off nan warnings for this statement</span>
                        <span class="c1">#</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                        <span class="n">flagged</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">])</span> <span class="o">&gt;</span> \
                            <span class="n">outlier_deviation_level</span> <span class="o">*</span> \
                            <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">]</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;IMT: </span><span class="si">%s</span><span class="s1">, flagged: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                                         <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flagged</span><span class="p">)))</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagged</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                                           <span class="kc">False</span><span class="p">,</span>
                                                           <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="c1"># If uncertainty hasn&#39;t been set for MMI, give it</span>
                    <span class="c1"># the default value</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_mmi_stddev&#39;</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># Get the lons/lats in radians while we&#39;re at it</span>
                <span class="c1">#</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">])</span>
                <span class="c1">#</span>
                <span class="c1"># It will be handy later on to have the rupture distance</span>
                <span class="c1"># in the dataframes</span>
                <span class="c1">#</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">([</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span>
                                  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">rupture_obj</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">]</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">]</span>

    <span class="c1"># %%</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Compute all the IMTs possible from MMI</span>
        <span class="c1"># TODO: This logic needs to be revisited. We should probably make what</span>
        <span class="c1"># we have to to do the CMS to make the needed output IMTs, but</span>
        <span class="c1"># for now, we&#39;re just going to use what we have and the ccf.</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">df2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gmice_imt</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span> <span class="o">==</span> <span class="n">gmice_imt</span><span class="p">:</span>
                    <span class="n">iterlist</span> <span class="o">=</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iterlist</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">iterlist</span><span class="p">:</span>
                    <span class="n">oqimt</span> <span class="o">=</span> <span class="n">gmice_imt</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
                    <span class="n">imtstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)</span>

                    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gmice</span><span class="o">.</span><span class="n">getGMfromMI</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span>
                                                       <span class="n">dists</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span>
                                                       <span class="n">mag</span><span class="o">=</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;min_mmi_convert&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">gmice</span><span class="o">.</span><span class="n">getMI2GMsd</span><span class="p">()[</span><span class="n">oqimt</span><span class="p">])</span>
                    <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="c1"># Get the predictions and stddevs</span>
                    <span class="c1">#</span>
                    <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
                    <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="n">gmas</span><span class="p">(</span><span class="n">ipe</span><span class="p">,</span> <span class="n">gmpe</span><span class="p">,</span> <span class="n">sx_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">],</span> <span class="n">rx</span><span class="p">,</span>
                                          <span class="n">dx_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">stddev_types</span><span class="p">)</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">total_sd_only</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">]</span>
                        <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                            <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">],</span> <span class="n">tau_guess</span><span class="p">)</span>
                        <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
                                                            <span class="n">tau_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">oqimt</span><span class="p">)]</span> <span class="o">-</span> <span class="n">pmean</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                            <span class="n">pmean</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Now make derived MMI from the best available PGM; This is ugly and</span>
        <span class="c1"># it would be nice to have a more deterministic way of doing it</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">df1</span><span class="p">:</span>
            <span class="n">imtstr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">df1</span> \
                    <span class="ow">and</span> <span class="n">imt</span><span class="o">.</span><span class="n">PGV</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span><span class="p">:</span>
                <span class="n">imtstr</span> <span class="o">=</span> <span class="s1">&#39;PGV&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">in</span> <span class="n">df1</span> \
                    <span class="ow">and</span> <span class="n">imt</span><span class="o">.</span><span class="n">PGA</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span><span class="p">:</span>
                <span class="n">imtstr</span> <span class="o">=</span> <span class="s1">&#39;PGA&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;SA(1.0)&#39;</span> <span class="ow">in</span> <span class="n">df1</span> \
                    <span class="ow">and</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span> \
                    <span class="ow">and</span> <span class="mf">1.0</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span><span class="p">:</span>
                <span class="n">imtstr</span> <span class="o">=</span> <span class="s1">&#39;SA(1.0)&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;SA(0.3)&#39;</span> <span class="ow">in</span> <span class="n">df1</span> \
                    <span class="ow">and</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span> \
                    <span class="ow">and</span> <span class="mf">0.3</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span><span class="p">:</span>
                <span class="n">imtstr</span> <span class="o">=</span> <span class="s1">&#39;SA(0.3)&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;SA(3.0)&#39;</span> <span class="ow">in</span> <span class="n">df1</span> \
                    <span class="ow">and</span> <span class="n">imt</span><span class="o">.</span><span class="n">SA</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_INTENSITY_MEASURE_TYPES</span> \
                    <span class="ow">and</span> <span class="mf">3.0</span> <span class="ow">in</span> <span class="n">gmice</span><span class="o">.</span><span class="n">DEFINED_FOR_SA_PERIODS</span><span class="p">:</span>
                <span class="n">imtstr</span> <span class="o">=</span> <span class="s1">&#39;SA(3.0)&#39;</span>

            <span class="k">if</span> <span class="n">imtstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gmice</span><span class="o">.</span><span class="n">getMIfromGM</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">oqimt</span><span class="p">,</span>
                                                  <span class="n">dists</span><span class="o">=</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">],</span>
                                                  <span class="n">mag</span><span class="o">=</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span>
                                             <span class="n">gmice</span><span class="o">.</span><span class="n">getGM2MIsd</span><span class="p">()[</span><span class="n">oqimt</span><span class="p">])</span>
                <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Get the prediction and stddevs</span>
                <span class="c1">#</span>
                <span class="n">gmpe</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">pmean</span><span class="p">,</span> <span class="n">pstddev</span> <span class="o">=</span> <span class="n">gmas</span><span class="p">(</span><span class="n">ipe</span><span class="p">,</span> <span class="n">gmpe</span><span class="p">,</span> <span class="n">sx_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">],</span> <span class="n">rx</span><span class="p">,</span>
                                      <span class="n">dx_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">],</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">),</span>
                                      <span class="n">stddev_types</span><span class="p">)</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmean</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">total_sd_only</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">tau_guess</span> <span class="o">=</span> <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">]</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred&#39;</span><span class="p">],</span> <span class="n">tau_guess</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pstddev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
                                                       <span class="n">tau_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pstddev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmean</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">pmean</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

        <span class="n">imt_per</span> <span class="o">=</span> <span class="n">get_period_array</span><span class="p">(</span><span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">],</span>
                                   <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">],</span>
                                   <span class="n">imt_out_set_str</span><span class="p">)</span>
        <span class="n">ccf</span> <span class="o">=</span> <span class="n">get_object_from_config</span><span class="p">(</span><span class="s1">&#39;ccf&#39;</span><span class="p">,</span> <span class="s1">&#39;modeling&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">imt_per</span><span class="p">)</span>

        <span class="n">imt_per_ix</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">per</span><span class="p">):</span> <span class="n">ix</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">per</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imt_per</span><span class="p">)}</span>
    <span class="c1"># %%</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Do the MVN</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1">#</span>
        <span class="c1"># First do the bias for all of the input and output IMTs. Hold on</span>
        <span class="c1"># to some of the products that will be used for the interpolation.</span>
        <span class="c1">#</span>
        <span class="n">nominal_bias</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bias_num</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># The numerator term of the bias</span>
        <span class="n">bias_den</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># The denominator term of the bias</span>
        <span class="n">outgrid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">outsd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># phi of the output points</span>
        <span class="n">tsd</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># tau of the output points</span>

        <span class="n">sta_period_ix</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_lons_rad</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_lats_rad</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_resids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_phi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_sig_extra</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_sig_total</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_tau</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sta_imtstr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">corr_adj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">corr22</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#</span>
        <span class="c1"># Compute a bias for all of the IMTs in the inputs and outputs</span>
        <span class="c1">#</span>
        <span class="n">combined_imt_str</span> <span class="o">=</span> <span class="n">imt_out_set_str</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]:</span>
            <span class="n">combined_imt_str</span> <span class="o">|=</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">]:</span>
            <span class="n">combined_imt_str</span> <span class="o">|=</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">combined_imt_str</span><span class="p">:</span>
            <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># Get the index of the (pseudo-) period of the output IMT</span>
            <span class="c1">#</span>
            <span class="n">outperiod_ix</span> <span class="o">=</span> <span class="n">get_period_index_from_imt_str</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">imt_per_ix</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Fill the station arrays</span>
            <span class="c1">#</span>
            <span class="n">period_ix</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lons_rad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lats_rad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sig_extra</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">imtlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rrups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ndf</span><span class="p">,</span> <span class="n">sdf</span> <span class="ow">in</span> <span class="n">df_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])):</span>
                    <span class="k">for</span> <span class="n">imtin</span> <span class="ow">in</span> <span class="n">get_sta_imts</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">sdf</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                              <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]):</span>
                        <span class="n">imtlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imtin</span><span class="p">)</span>
                        <span class="n">inperiod_ix</span> <span class="o">=</span> <span class="n">get_period_index_from_imt_str</span><span class="p">(</span>
                            <span class="n">imtin</span><span class="p">,</span> <span class="n">imt_per_ix</span><span class="p">)</span>
                        <span class="n">period_ix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inperiod_ix</span><span class="p">)</span>
                        <span class="n">lons_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;lon_rad&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">lats_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;lat_rad&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">resids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_residual&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">tau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_pred_tau&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">_phi</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_pred_phi&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">phi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_phi</span><span class="p">)</span>
                        <span class="n">sig_extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">imtin</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">rrups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sta_imtstr</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imtlist</span><span class="p">)</span>
            <span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">period_ix</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lons_rad</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lats_rad</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig_extra</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_sig_total</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons_rad</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">continue</span>
            <span class="c1">#</span>
            <span class="c1"># Get the distance-limited set of data</span>
            <span class="c1">#</span>
            <span class="n">dindx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rrups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bias_max_range</span>
            <span class="n">sta_phi_dl</span> <span class="o">=</span> <span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dindx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_tau_dl</span> <span class="o">=</span> <span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dindx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_sig_total_dl</span> <span class="o">=</span> <span class="n">sta_sig_total</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dindx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_lons_rad_dl</span> <span class="o">=</span> <span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dindx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_lats_rad_dl</span> <span class="o">=</span> <span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dindx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_period_ix_dl</span> <span class="o">=</span> <span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dindx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sta_resids_dl</span> <span class="o">=</span> <span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">dindx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1">#</span>
            <span class="c1"># This builds the omega factors to apply to the covariance</span>
            <span class="c1">#</span>
            <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_phi_dl</span> <span class="o">/</span> <span class="n">sta_sig_total_dl</span>
            <span class="n">corr_adj22</span> <span class="o">=</span> <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_adj22</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Build the covariance matrix of the residuals</span>
            <span class="c1">#</span>
            <span class="n">dist22</span> <span class="o">=</span> <span class="n">geodetic_distance_fast</span><span class="p">(</span><span class="n">sta_lons_rad_dl</span><span class="p">,</span>
                                            <span class="n">sta_lats_rad_dl</span><span class="p">,</span>
                                            <span class="n">sta_lons_rad_dl</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">sta_lats_rad_dl</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">d22_rows</span><span class="p">,</span> <span class="n">d22_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dist22</span><span class="p">)</span>  <span class="c1"># should be square</span>
            <span class="n">t1_22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sta_period_ix_dl</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d22_cols</span><span class="p">))</span>
            <span class="n">t2_22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sta_period_ix_dl</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">d22_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">corr22</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_22</span><span class="p">,</span> <span class="n">t2_22</span><span class="p">,</span> <span class="n">dist22</span><span class="p">)</span>
            <span class="n">sigma22</span> <span class="o">=</span> <span class="n">corr22</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">corr_adj22</span> <span class="o">*</span> \
                    <span class="p">(</span><span class="n">sta_phi_dl</span> <span class="o">*</span> <span class="n">sta_phi_dl</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">sigma22inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">sigma22</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Compute the bias numerator and denominator pieces</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">do_bias</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rupture_obj</span><span class="p">,</span> <span class="n">PointRupture</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="n">rx</span><span class="o">.</span><span class="n">mag</span> <span class="o">&lt;=</span> <span class="n">bias_max_mag</span><span class="p">):</span>
                <span class="c1">#</span>
                <span class="c1"># Get the correlation between the inputs and outputs</span>
                <span class="c1">#</span>
                <span class="n">out_ix_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">sta_period_ix_dl</span><span class="p">,</span> <span class="n">outperiod_ix</span><span class="p">)</span>
                <span class="n">dist_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">out_ix_arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">sta_period_ix_dl</span><span class="p">,</span> <span class="n">out_ix_arr</span><span class="p">,</span>
                                       <span class="n">dist_arr</span><span class="p">)</span> 
                <span class="c1">#</span>
                <span class="c1"># Scale the correlation factor (Z) by the correlation</span>
                <span class="c1"># adjustment due to observational uncertainty</span>
                <span class="c1">#</span>
                <span class="n">Z</span> <span class="o">*=</span> <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># Compute the bias denominator and numerator terms</span>
                <span class="c1">#</span>
                <span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma22inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
                <span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma22inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span> <span class="o">*</span> <span class="n">sta_resids_dl</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">nom_tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sta_tau_dl</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">nom_variance</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">nom_tau</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">nom_variance</span>
            <span class="n">bias_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
            <span class="c1">#</span>
            <span class="c1"># Print the nominal values of the bias and its stddev</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: nom bias </span><span class="si">%f</span><span class="s1"> nom stddev </span><span class="si">%f</span><span class="s1">; </span><span class="si">%d</span><span class="s1"> stations (time=</span><span class="si">%f</span><span class="s1"> sec)&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">nominal_bias</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nom_variance</span><span class="p">),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]),</span> <span class="n">bias_time</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="c1"># End bias</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># Now do the MVN with the intra-event residuals</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imt_out_set_str</span><span class="p">:</span>
            <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># Get the index of the (pesudo-) period of the output IMT</span>
            <span class="c1">#</span>
            <span class="n">outperiod_ix</span> <span class="o">=</span> <span class="n">get_period_index_from_imt_str</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">imt_per_ix</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Get the predictions at the output points</span>
            <span class="c1">#</span>
            <span class="n">oqimt</span> <span class="o">=</span> <span class="n">imt</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">imtstr</span><span class="p">)</span>
            <span class="n">gmpe</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">!=</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                <span class="n">gmpe</span> <span class="o">=</span> <span class="n">MultiGMPE</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">filter_imt</span><span class="o">=</span><span class="n">oqimt</span><span class="p">)</span>
            <span class="n">pout_mean</span><span class="p">,</span> <span class="n">pout_sd</span> <span class="o">=</span> <span class="n">gmas</span><span class="p">(</span><span class="n">ipe</span><span class="p">,</span> <span class="n">gmpe</span><span class="p">,</span> <span class="n">sx_out_soil</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">dx_out</span><span class="p">,</span>
                                      <span class="n">oqimt</span><span class="p">,</span> <span class="n">stddev_types</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># If there are no data, just use the unbiased prediction</span>
            <span class="c1"># and the total stddev</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">outgrid</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_mean</span>
                <span class="n">outsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="c1">#</span>
            <span class="c1"># Get an array of the within-event standard deviations for the</span>
            <span class="c1"># output IMT at the output points</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">total_sd_only</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pout_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
                                      <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span>
                                           <span class="n">SM_CONSTS</span><span class="p">[</span><span class="s1">&#39;default_stddev_inter&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pout_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pout_sd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Bias the predictions, and add the residual variance to</span>
            <span class="c1"># phi</span>
            <span class="c1">#</span>
            <span class="n">out_bias_var</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">tsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias_den</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="n">out_bias</span> <span class="o">=</span> <span class="n">bias_num</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">out_bias_var</span>
            <span class="n">pout_mean</span> <span class="o">+=</span> <span class="n">out_bias</span>
            <span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">out_bias_var</span><span class="p">)</span>
            <span class="n">pout_sd2</span> <span class="o">+=</span> <span class="n">out_bias_var</span>
            <span class="c1">#</span>
            <span class="c1"># Unbias the station residuals and compute the </span>
            <span class="c1"># new phi that includes the variance of the bias</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])):</span>
                <span class="n">imtin</span> <span class="o">=</span> <span class="n">sta_imtstr</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">in_bias_var</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sta_tau</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                     <span class="n">bias_den</span><span class="p">[</span><span class="n">imtin</span><span class="p">])</span>
                <span class="n">in_bias</span> <span class="o">=</span> <span class="n">bias_num</span><span class="p">[</span><span class="n">imtin</span><span class="p">]</span> <span class="o">*</span> <span class="n">in_bias_var</span>
                <span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">in_bias</span>
                <span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                                <span class="n">in_bias_var</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Update the omega factors to account for the bias and the</span>
            <span class="c1"># new value of phi</span>
            <span class="c1">#</span>
            <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">/</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sta_sig_extra</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">corr_adj22</span> <span class="o">=</span> <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_adj22</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Re-build the covariance matrix of the residuals with</span>
            <span class="c1"># the full set of data</span>
            <span class="c1">#</span>
            <span class="n">dist22</span> <span class="o">=</span> <span class="n">geodetic_distance_fast</span><span class="p">(</span><span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span>
                                            <span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span>
                                            <span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">d22_rows</span><span class="p">,</span> <span class="n">d22_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dist22</span><span class="p">)</span>  <span class="c1"># should be square</span>
            <span class="n">t1_22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d22_cols</span><span class="p">))</span>
            <span class="n">t2_22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">d22_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">corr22</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_22</span><span class="p">,</span> <span class="n">t2_22</span><span class="p">,</span> <span class="n">dist22</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Rebuild sigma22_inv now that we have updated phi and </span>
            <span class="c1"># the correlation adjustment factors</span>
            <span class="c1">#</span>
            <span class="n">sigma22</span> <span class="o">=</span> <span class="n">corr22</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">corr_adj22</span> <span class="o">*</span> \
                    <span class="p">(</span><span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">sigma22inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">sigma22</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Now do the MVN itself...</span>
            <span class="c1">#</span>
            <span class="n">dtime</span> <span class="o">=</span> <span class="n">mtime</span> <span class="o">=</span> <span class="n">ddtime</span> <span class="o">=</span> <span class="n">ctime</span> <span class="o">=</span> <span class="n">stime</span> <span class="o">=</span> <span class="n">atime</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">ampgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">)</span>
            <span class="n">sdgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pout_mean</span><span class="p">)</span>
            <span class="n">corr_adj12</span> <span class="o">=</span> <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">smnx</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">smny</span><span class="p">):</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">*</span> <span class="n">smnx</span>
                <span class="n">se</span> <span class="o">=</span> <span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">smnx</span>
                <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">dist12</span> <span class="o">=</span> <span class="n">geodetic_distance_fast</span><span class="p">(</span>
                    <span class="n">lons_out_rad</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">lats_out_rad</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">se</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">sta_lons_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span>
                    <span class="n">sta_lats_rad</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
                <span class="n">t2_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">dist12</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">outperiod_ix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">d12_rows</span><span class="p">,</span> <span class="n">d12_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dist12</span><span class="p">)</span>
                <span class="n">t1_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sta_period_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d12_cols</span><span class="p">))</span>
                <span class="n">ddtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
                <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">corr12</span> <span class="o">=</span> <span class="n">ccf</span><span class="o">.</span><span class="n">getCorrelation</span><span class="p">(</span><span class="n">t1_12</span><span class="p">,</span> <span class="n">t2_12</span><span class="p">,</span> <span class="n">dist12</span><span class="p">)</span>
                <span class="n">ctime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
                <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1"># sdarr is the standard deviation of the output sites</span>
                <span class="n">sdarr</span> <span class="o">=</span> <span class="n">psd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">][</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="c1"># ss is the standard deviation of the stations</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">sta_phi</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
                <span class="n">sigma12</span> <span class="o">=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;corr12 * corr_adj12 * (ss * sdarr)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">stime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
                <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1">#</span>
                <span class="c1"># Sigma12 * Sigma22^-1 is known as the &#39;regression </span>
                <span class="c1"># coefficient&#39; matrix (rcmatrix)</span>
                <span class="c1">#</span>
                <span class="n">rcmatrix</span> <span class="o">=</span> <span class="n">sigma12</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma22inv</span><span class="p">)</span>
                <span class="n">dtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
                <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1">#</span>
                <span class="c1"># This is the MVN solution for the conditional mean</span>
                <span class="c1">#</span>
                <span class="n">adj_resid</span> <span class="o">=</span> <span class="n">corr_adj</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">*</span> <span class="n">sta_resids</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span>
                <span class="n">ampgrid</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                    <span class="n">pout_mean</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">rcmatrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">adj_resid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
                <span class="n">atime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>
                <span class="n">time4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1">#</span>
                <span class="c1"># We only want the diagonal elements of the conditional</span>
                <span class="c1"># covariance matrix, so there is no point in doing the </span>
                <span class="c1"># full solution with the dot product, e.g.:</span>
                <span class="c1"># sdgrid[ss:se] = pout_sd2[ss:se] - np.diag(rcmatrix.dot(sigma12))</span>
                <span class="c1">#</span>
                <span class="n">sdgrid</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                    <span class="n">pout_sd2</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rcmatrix</span> <span class="o">*</span> <span class="n">sigma12</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mtime</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time4</span>

            <span class="n">outgrid</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampgrid</span>
            <span class="n">sdgrid</span><span class="p">[</span><span class="n">sdgrid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">outsd</span><span class="p">[</span><span class="n">imtstr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sdgrid</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> distance=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">ddtime</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> correlation=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">ctime</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> sigma=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">stime</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> rcmatrix=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">dtime</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> amp calc=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">atime</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time for </span><span class="si">%s</span><span class="s1"> sd calc=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;total time for </span><span class="si">%s</span><span class="s1">=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span><span class="p">))</span>

    <span class="c1"># %%</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Output the data and metadata</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">product_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">product_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">product_path</span><span class="p">)</span>
        <span class="n">oc</span> <span class="o">=</span> <span class="n">ShakeMapOutputContainer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">product_path</span><span class="p">,</span> <span class="s1">&#39;shake_result.hdf&#39;</span><span class="p">))</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Might as well stick the whole config in the result</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setConfig</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># We&#39;re going to need masked arrays of the output grids later, so</span>
        <span class="c1"># make them now. We only need to make the mask once, then we can</span>
        <span class="c1"># apply it to all of the other grids.</span>
        <span class="c1">#</span>
        <span class="n">moutgrid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">refimt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">imt_out_set_str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1"># Don&#39;t know what to do about this warning; hopefully someone</span>
        <span class="c1"># will fix maskoceans()</span>
        <span class="c1">#</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                                    <span class="n">category</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">VisibleDeprecationWarning</span><span class="p">)</span>
            <span class="n">moutgrid</span><span class="p">[</span><span class="n">refimt</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">maskoceans</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">smny</span><span class="p">,</span> <span class="n">smnx</span><span class="p">)),</span>
                           <span class="n">lats</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">smny</span><span class="p">,</span> <span class="n">smnx</span><span class="p">)),</span>
                           <span class="n">outgrid</span><span class="p">[</span><span class="n">refimt</span><span class="p">],</span> <span class="n">inlands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">imtout</span> <span class="ow">in</span> <span class="n">imt_out_set_str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imtout</span> <span class="o">==</span> <span class="n">refimt</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">moutgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">outgrid</span><span class="p">[</span><span class="n">imtout</span><span class="p">],</span>
                                <span class="n">mask</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="n">refimt</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="c1"># Get the map grade</span>
        <span class="c1">#</span>
        <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span> <span class="o">=</span> <span class="n">get_map_grade</span><span class="p">(</span><span class="n">do_grid</span><span class="p">,</span> <span class="n">outsd</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">moutgrid</span><span class="p">)</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># This is the metadata for creating info.json</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;input&#39;</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="s1">&#39;event_information&#39;</span>
        <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="s1">&#39;ground_motions&#39;</span>
        <span class="n">mi</span> <span class="o">=</span> <span class="s1">&#39;map_information&#39;</span>
        <span class="n">un</span> <span class="o">=</span> <span class="s1">&#39;uncertainty&#39;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="s1">&#39;processing&#39;</span>
        <span class="n">gmm</span> <span class="o">=</span> <span class="s1">&#39;ground_motion_modules&#39;</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="s1">&#39;miscellaneous&#39;</span>
        <span class="n">sv</span> <span class="o">=</span> <span class="s1">&#39;shakemap_versions&#39;</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="s1">&#39;site_response&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_depth</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventid</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;fault_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rupture_obj</span><span class="o">.</span><span class="n">getReference</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;intensity_observations&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">df2</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lat</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">hypo_lon</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">locstring</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;magnitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;origin_time&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;seismic_stations&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">df1</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;src_mech&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">mech</span>
        <span class="c1"># This AND locaction?</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">locstring</span>
        <span class="c1"># This AND src_mech?</span>
        <span class="n">info</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ei</span><span class="p">][</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rupture_obj</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">mech</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="n">imt_out_set_str</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
            <span class="k">elif</span> <span class="n">myimt</span> <span class="o">==</span> <span class="s1">&#39;PGV&#39;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;cms&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;ln(g)&#39;</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">nominal_bias</span><span class="p">[</span><span class="n">myimt</span><span class="p">])</span> <span class="k">if</span> <span class="n">myimt</span> <span class="ow">in</span> <span class="n">nominal_bias</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;max_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">]))</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">gm</span><span class="p">][</span><span class="n">myimt</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="n">myimt</span><span class="p">]))</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">smnx</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">smny</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_points&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">smdx</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">smdy</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_spacing&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">E</span> <span class="o">-</span> <span class="n">W</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">S</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;grid_span&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mygrade</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;mean_uncertainty_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_rat</span>
        <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;total_flagged_mi&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">]</span> <span class="o">|</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">])))</span> <span class="k">if</span> <span class="n">df2</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">if</span> <span class="n">df1</span><span class="p">:</span>
            <span class="n">all_flagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imt_in_str_dict</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">in</span> <span class="n">imtstr</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">all_flagged</span> <span class="o">|=</span> \
                    <span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">imtstr</span><span class="p">])</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;total_flagged_pgm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_flagged</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="n">un</span><span class="p">][</span><span class="s1">&#39;total_flagged_pgm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmpe&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ipe_modules&#39;</span><span class="p">][</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ipe&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gmice_modules&#39;</span><span class="p">][</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;gmice&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ccf_modules&#39;</span><span class="p">][</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;ccf&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;basin_correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;basin_correction&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;basin_correction&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;directivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;directivity&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">gmm</span><span class="p">][</span><span class="s1">&#39;directivity&#39;</span><span class="p">][</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;bias_max_dsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bias_max_dsigma</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;bias_max_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bias_max_mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;bias_max_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bias_max_range</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;median_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;outlier_deviation_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outlier_deviation_level</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">ms</span><span class="p">][</span><span class="s1">&#39;outlier_max_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outlier_max_mag</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;shakemap_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_versions</span><span class="p">()[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;shakemap_revision_id&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">get_versions</span><span class="p">()[</span><span class="s1">&#39;full-revisionid&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;process_time&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S%Z&quot;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">())</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;map_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s1">&#39;history&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;map_data_history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">getVersionHistory</span><span class="p">()[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sv</span><span class="p">][</span><span class="s1">&#39;map_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;map_status&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">][</span><span class="s1">&#39;vs30default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vs30default</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="n">pp</span><span class="p">][</span><span class="n">sr</span><span class="p">][</span><span class="s1">&#39;site_correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GMPE native&#39;</span>

        <span class="n">oc</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="s1">&#39;info.json&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Add the rupture JSON as a text string</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">oc</span><span class="o">.</span><span class="n">setRupture</span><span class="p">(</span><span class="n">rupture_obj</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Add the station data. The stationlist object has the original</span>
        <span class="c1"># data and produces a GeoJSON object (a dictionary, really), but</span>
        <span class="c1"># we need to add peak values and flagging that has been done here.</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">stations</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># First make a dictionary of distances</span>
            <span class="c1">#</span>
            <span class="n">dist_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df1&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;df2&#39;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">ndf</span><span class="p">,</span> <span class="n">sdf</span> <span class="ow">in</span> <span class="n">df_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
                    <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dx_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">],</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">dm</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm_arr</span>
            <span class="c1">#</span>
            <span class="c1"># Get the index for each station ID</span>
            <span class="c1">#</span>
            <span class="n">sjdict</span> <span class="o">=</span> <span class="n">stations</span><span class="o">.</span><span class="n">getGeoJson</span><span class="p">()</span>
            <span class="n">sta_ix</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ndf</span><span class="p">,</span> <span class="n">sdf</span> <span class="ow">in</span> <span class="n">df_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">:</span>
                    <span class="n">sta_ix</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sta_ix</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))))</span>
            <span class="c1">#</span>
            <span class="c1"># Now go through the GeoJSON and add various properties and</span>
            <span class="c1"># amps from the df_dict dictionaries</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">sjdict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">]:</span>
                    <span class="n">sdf</span> <span class="o">=</span> <span class="n">df1</span>
                    <span class="n">ndf</span> <span class="o">=</span> <span class="s1">&#39;df1&#39;</span>
                    <span class="n">six</span> <span class="o">=</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s1">&#39;df1&#39;</span><span class="p">][</span><span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">]:</span>
                    <span class="n">sdf</span> <span class="o">=</span> <span class="n">df2</span>
                    <span class="n">ndf</span> <span class="o">=</span> <span class="s1">&#39;df2&#39;</span>
                    <span class="n">six</span> <span class="o">=</span> <span class="n">sta_ix</span><span class="p">[</span><span class="s1">&#39;df2&#39;</span><span class="p">][</span><span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown station </span><span class="si">%s</span><span class="s1"> in stationlist&#39;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">station</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
                <span class="c1">#</span>
                <span class="c1"># Set the &#39;intensity&#39;, &#39;pga&#39;, and &#39;pga&#39; peak properties</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">in</span> <span class="n">sdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity_stddev&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;MMI_sd&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;intensity_stddev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>

                <span class="k">if</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">in</span> <span class="n">sdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGA_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pga&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGA&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>

                <span class="k">if</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">sdf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGV_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;PGV&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;pgv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
                <span class="c1">#</span>
                <span class="c1"># Add the predictions so we can plot residuals</span>
                <span class="c1">#</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sdf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_pred&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">myamp</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;cm/s&#39;</span>
                    <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">myamp</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">myamp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">total_sd_only</span><span class="p">:</span>
                        <span class="n">mytau</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mytau</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_tau&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">myphi</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_phi&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                    <span class="n">mysigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mytau</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">myphi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">imt_name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;predictions&#39;</span><span class="p">][</span><span class="n">imt_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                            <span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="n">mytau</span><span class="p">,</span>
                            <span class="s1">&#39;phi&#39;</span><span class="p">:</span> <span class="n">myphi</span><span class="p">,</span>
                            <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">mysigma</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="c1">#</span>
                <span class="c1"># Set the generic distance property (this is rrup)</span>
                <span class="c1">#</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;rrup&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># Set the specific distances properties</span>
                <span class="c1">#</span>
                <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span> <span class="ow">in</span> <span class="n">dist_dict</span><span class="p">[</span><span class="n">ndf</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;distances&#39;</span><span class="p">][</span><span class="n">dm</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm_arr</span><span class="p">[</span><span class="n">six</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># Set the outlier flags</span>
                <span class="c1">#</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">station</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">amp</span> <span class="ow">in</span> <span class="n">channel</span><span class="p">[</span><span class="s1">&#39;amplitudes&#39;</span><span class="p">]:</span>
                        <span class="n">Name</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">sdf</span><span class="p">[</span><span class="n">Name</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">][</span><span class="n">six</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                                <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;T&#39;</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]:</span>
                            <span class="n">amp</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sjdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">oc</span><span class="o">.</span><span class="n">setStationDict</span><span class="p">(</span><span class="n">sjdict</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Add the output grids or points to the output; include some</span>
        <span class="c1"># metadata.</span>
        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">do_grid</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">W</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;nx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smnx</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;ny&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smny</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smdx</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smdy</span>
            <span class="n">gdict</span> <span class="o">=</span> <span class="n">GeoDict</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Put the Vs30 grid in the output container</span>
            <span class="c1">#</span>
            <span class="n">layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">get_layer_info</span><span class="p">(</span><span class="s1">&#39;vs30&#39;</span><span class="p">)</span>
            <span class="n">vs30</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">sx_out_soil</span><span class="o">.</span><span class="n">vs30</span><span class="p">,</span> <span class="n">gdict</span><span class="p">)</span>
            <span class="n">vs30_metadata</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">vs30_metadata</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="n">vs30_metadata</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="s1">&#39;vs30&#39;</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">vs30_metadata</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Now do the distance grids</span>
            <span class="c1">#</span>
            <span class="n">dist_metadata</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dist_metadata</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span>
            <span class="n">dist_metadata</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
                <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dm_arr_2d</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">dm_arr</span><span class="p">,</span> <span class="n">gdict</span><span class="p">)</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="s1">&#39;distance_&#39;</span> <span class="o">+</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr_2d</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">dist_metadata</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Output the data and uncertainty grids</span>
            <span class="c1">#</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;component&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">outgrid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># set the data grid</span>
                <span class="n">mean_grid</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">gdict</span><span class="p">)</span>
                <span class="n">mean_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">get_layer_info</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">mean_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                                 <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="n">digits</span><span class="p">}</span>

                <span class="c1"># set the uncertainty grid</span>
                <span class="n">std_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">get_layer_info</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">)</span>
                <span class="n">std_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                                <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="n">digits</span><span class="p">}</span>
                <span class="n">std_grid</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">outsd</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">gdict</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setIMTGrids</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                          <span class="n">mean_grid</span><span class="p">,</span> <span class="n">mean_metadata</span><span class="p">,</span>
                          <span class="n">std_grid</span><span class="p">,</span> <span class="n">std_metadata</span><span class="p">,</span>
                          <span class="n">component</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Store the Vs30</span>
            <span class="c1">#</span>
            <span class="n">vs30_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m/s&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="s1">&#39;vs30&#39;</span><span class="p">,</span> <span class="n">vs30</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">metadata</span><span class="o">=</span><span class="n">vs30_metadata</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Store the distances</span>
            <span class="c1">#</span>
            <span class="n">distance_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;km&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">get_distance_measures</span><span class="p">():</span>
                <span class="n">dm_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dx_out</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dm_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="s1">&#39;distance_&#39;</span> <span class="o">+</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dm_arr</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                            <span class="n">metadata</span><span class="o">=</span><span class="n">distance_metadata</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Store the IMTs</span>
            <span class="c1">#</span>
            <span class="n">ascii_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idents</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;interp&#39;</span><span class="p">][</span><span class="s1">&#39;component&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">outgrid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># set the data grid</span>
                <span class="n">mean_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">get_layer_info</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">mean_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                                 <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="n">digits</span><span class="p">}</span>
                <span class="c1"># set the uncertainty grid</span>
                <span class="n">std_layername</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">get_layer_info</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span><span class="p">)</span>
                <span class="n">std_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                                <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="n">digits</span><span class="p">}</span>
                <span class="n">oc</span><span class="o">.</span><span class="n">setIMTArrays</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                <span class="n">ascii_ids</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">mean_metadata</span><span class="p">,</span>
                                <span class="n">outsd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">std_metadata</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>

        <span class="n">oc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># End interp()</span>
    <span class="c1"># ------------------------------------------------------------------</span>


<div class="viewcode-block" id="get_period_index_from_imt_str"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.get_period_index_from_imt_str">[docs]</a><span class="k">def</span> <span class="nf">get_period_index_from_imt_str</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">imt_per_ix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the index for the period of the specified IMT.</span>

<span class="sd">    Args:</span>
<span class="sd">        imtstr (str): The (OQ-style) IMT string.</span>
<span class="sd">        imt_per_ix (dict): Dictionary relating periods to their</span>
<span class="sd">            indices.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The index corresponding to the period of the IMT.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGA&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">imt_per_ix</span><span class="p">[</span><span class="s1">&#39;0.01&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="s1">&#39;MMI&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">imt_per_ix</span><span class="p">[</span><span class="s1">&#39;1.0&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">imt_per_ix</span><span class="p">[</span><span class="n">imtstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span></div>


<div class="viewcode-block" id="get_period_array"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.get_period_array">[docs]</a><span class="k">def</span> <span class="nf">get_period_array</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an array of the periods represented by the IMT list(s) in</span>
<span class="sd">    the input.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args (list): One or more lists of IMTs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        array: Numpy array of the (sorted) periods represented by the</span>
<span class="sd">        IMTs in the input list(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imt_per</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">imt_list</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">imt_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imt_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGA&#39;</span><span class="p">:</span>
                <span class="n">imt_per</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">or</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
                <span class="n">imt_per</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imt_per</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">imtstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">imt_per</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_imts"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.get_imts">[docs]</a><span class="k">def</span> <span class="nf">get_imts</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">imtset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the input imt or its closest surrogarte (or bracket) found</span>
<span class="sd">    in imtset.</span>

<span class="sd">    Args:</span>
<span class="sd">        imtstr (str): An (OQ-style) IMT string.</span>
<span class="sd">        imtsset (set): A set of IMTs to search for imtstr or its closest</span>
<span class="sd">            surrogate (or bracket).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The IMT, it&#39;s closest surrogate, or a bracket of periods on</span>
<span class="sd">        either side of the IMT&#39;s period, from the IMTs in intset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">imtstr</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">salist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imtset</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">)]</span>
    <span class="n">periodlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">salist</span><span class="p">]</span>
    <span class="n">periodlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">periodlist</span><span class="p">)</span>
    <span class="n">periodlist_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">periodlist</span><span class="p">]</span>

    <span class="c1">#</span>
    <span class="c1"># If we&#39;re here, then we know that IMT isn&#39;t in the inputs. Try</span>
    <span class="c1"># some alternatives.</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGA&#39;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># Use the highest frequency in the inputs, otherwise use PGV</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">salist</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;SA(&#39;</span> <span class="o">+</span> <span class="n">periodlist_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;PGV&#39;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># Use 1.0 sec SA (or its bracket) if it&#39;s there, otherwise</span>
        <span class="c1"># use PGA</span>
        <span class="c1">#</span>
        <span class="n">sa_tuple</span> <span class="o">=</span> <span class="n">get_sa_bracket</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">periodlist</span><span class="p">,</span> <span class="n">periodlist_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sa_tuple</span> <span class="o">!=</span> <span class="p">():</span>
            <span class="k">return</span> <span class="n">sa_tuple</span>
        <span class="k">if</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;PGA&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">imtstr</span> <span class="o">==</span> <span class="s1">&#39;MMI&#39;</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># Use PGV if it&#39;s there, otherwise use 1.0 sec SA (or its</span>
        <span class="c1"># bracket)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s1">&#39;PGV&#39;</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">get_sa_bracket</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">periodlist</span><span class="p">,</span> <span class="n">periodlist_str</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">imtstr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">):</span>
        <span class="n">myper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imtstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SA(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">get_sa_bracket</span><span class="p">(</span><span class="n">myper</span><span class="p">,</span> <span class="n">periodlist</span><span class="p">,</span> <span class="n">periodlist_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown IMT </span><span class="si">%s</span><span class="s1"> in get_imt_bracket&#39;</span> <span class="o">%</span> <span class="n">imtstr</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_sa_bracket"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.get_sa_bracket">[docs]</a><span class="k">def</span> <span class="nf">get_sa_bracket</span><span class="p">(</span><span class="n">myper</span><span class="p">,</span> <span class="n">plist</span><span class="p">,</span> <span class="n">plist_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given period, look through the input periods and return a tuple of</span>
<span class="sd">    a) the single IMT string representing the period itself if it is found</span>
<span class="sd">    in the input; b) a pair of IMT strings representing the periods</span>
<span class="sd">    bracketing the given period; or c) the single IMT representing the first</span>
<span class="sd">    or last period in the input list if the given period is off the end of</span>
<span class="sd">    the list.</span>

<span class="sd">    Args:</span>
<span class="sd">        myper (float): The period to search for in the input lists.</span>
<span class="sd">        plist (array): A sorted list of periods as floats.</span>
<span class="sd">        plist_str (array): The periods in &#39;plist&#39; (above) as strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: One or two strings representing the IMTs closest to or</span>
<span class="sd">        bracketing the input period.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;SA(&#39;</span> <span class="o">+</span> <span class="n">plist_str</span><span class="p">[</span><span class="n">plist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">myper</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plist</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">myper</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">myper</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;SA(&#39;</span> <span class="o">+</span> <span class="n">plist_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;SA(&#39;</span> <span class="o">+</span> <span class="n">plist_str</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;SA(&#39;</span> <span class="o">+</span> <span class="n">plist_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_sta_imts"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.get_sta_imts">[docs]</a><span class="k">def</span> <span class="nf">get_sta_imts</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">sdf</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">imtset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the IMT, its closest surrogate, or its bracket for a stataion</span>
<span class="sd">    in a particular station dataframe, accounting for missing or</span>
<span class="sd">    flagged data.</span>

<span class="sd">    Args:</span>
<span class="sd">        imtstr (str): The desired IMT as an OQ-style string.</span>

<span class="sd">        sdf (dict): The dataframe containing the station.</span>

<span class="sd">        ix (int): The index of the station in the dataframe.</span>

<span class="sd">        imtset (set): The list of IMTs (as OQ-style strings) in the</span>
<span class="sd">            dataframe.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The IMT, its closest surrogate, or the pair of IMTs</span>
<span class="sd">        bracketing it in period, gathered from the valid data for the</span>
<span class="sd">        station.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myimts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">this_imt</span> <span class="ow">in</span> <span class="n">imtset</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">this_imt</span><span class="p">][</span><span class="n">ix</span><span class="p">])</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">sdf</span><span class="p">[</span><span class="n">this_imt</span> <span class="o">+</span> <span class="s1">&#39;_outliers&#39;</span><span class="p">][</span><span class="n">ix</span><span class="p">]:</span>
            <span class="n">myimts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">this_imt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_imts</span><span class="p">(</span><span class="n">imtstr</span><span class="p">,</span> <span class="n">myimts</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_map_grade"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.get_map_grade">[docs]</a><span class="k">def</span> <span class="nf">get_map_grade</span><span class="p">(</span><span class="n">do_grid</span><span class="p">,</span> <span class="n">outsd</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">moutgrid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a &#39;grade&#39; for the map. Essentially looks at the ratio of</span>
<span class="sd">    the computed PGA uncertainty to the predicted PGA uncertainty for</span>
<span class="sd">    the area inside the MMI 6 contour. If the maximum MMI is less than</span>
<span class="sd">    6, or the map is not a grid, the grade and mean ratio are set to &#39;-&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        do_grid (bool): Is the map a grid (True) or a list of points</span>
<span class="sd">            (False)?</span>

<span class="sd">        outsd (dict): A dictionary of computed uncertainty arrays.</span>

<span class="sd">        psd (dict): A dictionary of predicted uncertainty arrays.</span>

<span class="sd">        moutgrid (dict): A dictionary of landmasked output ground</span>
<span class="sd">            motion arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The mean uncertainty ratio and the letter grade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_rat</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">mygrade</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_grid</span> <span class="ow">or</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outsd</span> <span class="ow">or</span> <span class="s1">&#39;PGA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psd</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span>
    <span class="n">sd_rat</span> <span class="o">=</span> <span class="n">outsd</span><span class="p">[</span><span class="s1">&#39;PGA&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;PGA&#39;</span><span class="p">]</span>
    <span class="n">mmimasked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">moutgrid</span><span class="p">[</span><span class="s1">&#39;MMI&#39;</span><span class="p">],</span> <span class="mf">6.0</span><span class="p">)</span>
    <span class="n">mpgasd_rat</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">sd_rat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mmimasked</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mpgasd_rat</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">gvals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">]</span>
        <span class="n">grades</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]</span>
        <span class="n">mean_rat</span> <span class="o">=</span> <span class="n">mpgasd_rat</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gvals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mean_rat</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">mygrade</span> <span class="o">=</span> <span class="n">grades</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">mygrade</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">mygrade</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>
    <span class="k">return</span> <span class="n">mean_rat</span><span class="p">,</span> <span class="n">mygrade</span></div>


<span class="c1"># we need a way to get units information about intensity measure types</span>
<span class="c1"># and translate between openquake naming convention and ShakeMap grid naming</span>
<span class="c1"># convention.</span>
<div class="viewcode-block" id="get_layer_info"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.get_layer_info">[docs]</a><span class="k">def</span> <span class="nf">get_layer_info</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We need a way to get units information about intensity measure types</span>
<span class="sd">    and translate between OpenQuake naming convention and ShakeMap grid naming</span>
<span class="sd">    convention.</span>

<span class="sd">    Args:</span>
<span class="sd">        layer (str): ShakeMap grid name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple including:</span>

<span class="sd">            - OpenQuake naming convention,</span>
<span class="sd">            - units,</span>
<span class="sd">            - significant digits.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer_out</span> <span class="o">=</span> <span class="n">layer</span>
    <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">layer_digits</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of significant digits</span>

    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_sd&#39;</span><span class="p">):</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">oq_to_file</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_sd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">layer_out</span> <span class="o">+</span> <span class="s1">&#39;_sd&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer_out</span> <span class="o">=</span> <span class="n">oq_to_file</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SA&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;ln(g)&#39;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PGA&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;ln(g)&#39;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PGV&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;ln(cm/s)&#39;</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MMI&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
        <span class="n">layer_digits</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;vs30&#39;</span><span class="p">):</span>
        <span class="n">layer_units</span> <span class="o">=</span> <span class="s1">&#39;m/s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown layer type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layer</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">layer_out</span><span class="p">,</span> <span class="n">layer_units</span><span class="p">,</span> <span class="n">layer_digits</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1"># Helper function to call get_mean_and_stddevs for the</span>
<span class="c1"># appropriate object given the IMT</span>
<span class="c1">#</span>
<div class="viewcode-block" id="gmas"><a class="viewcode-back" href="../../../apidoc/shakemap.coremods.model.html#shakemap.coremods.model.gmas">[docs]</a><span class="k">def</span> <span class="nf">gmas</span><span class="p">(</span><span class="n">ipe</span><span class="p">,</span> <span class="n">gmpe</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">stddev_types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a helper function to call get_mean_and_stddevs for the</span>
<span class="sd">    appropriate object given the IMT.</span>

<span class="sd">    Args:</span>
<span class="sd">        ipe: An IPE instance.</span>
<span class="sd">        gmpe: A GMPE instance.</span>
<span class="sd">        sx: Sites context.</span>
<span class="sd">        rx: Rupture context.</span>
<span class="sd">        dx: Distance context.</span>
<span class="sd">        oqimt: List of OpenQuake IMTs.</span>
<span class="sd">        stddev_types: list of OpenQuake standard deviation types.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple of two items:</span>

<span class="sd">            - Numpy array of means,</span>
<span class="sd">            - List of numpy array of standard deviations corresponding to the</span>
<span class="sd">              requested stddev_types.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;MMI&#39;</span> <span class="ow">in</span> <span class="n">oqimt</span><span class="p">:</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">ipe</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">gmpe</span>
    <span class="k">return</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_mean_and_stddevs</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">oqimt</span><span class="p">,</span> <span class="n">stddev_types</span><span class="p">)</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/northridge_thumbnail_light_16x9.png" alt="Logo"/>
    
    <h1 class="logo logo-name">ShakeMap Documentation</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual3_5/index.html">ShakeMap 3.5 Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manual4_0/title_page.html">ShakeMap 4 Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../programs/programs.html">ShakeMap 4.0a Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/shakemap.html">ShakeMap 4.0a API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../shakelib/shakelib.html">ShakeLib API</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
    </div>

    

    
  </body>
</html>